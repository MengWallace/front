/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&$("html").addClass("ismobile");var App=function(){function e(){function e(e,t,a){$(e).mCustomScrollbar({theme:t,scrollInertia:100,axis:"yx",mouseWheel:{enable:!0,axis:a,preventDefault:!0}})}if($("html").hasClass("ismobile")||$(".c-overflow")[0]&&e(".c-overflow","minimal-dark","y"),$(".fg-line")[0]&&($("body").on("focus",".fg-line .form-control",function(){$(this).closest(".fg-line").addClass("fg-toggled")}),$("body").on("blur",".form-control",function(){var e=$(this).closest(".form-group, .input-group"),t=e.find(".form-control").val();e.hasClass("fg-float")?0==t.length&&$(this).closest(".fg-line").removeClass("fg-toggled"):$(this).closest(".fg-line").removeClass("fg-toggled")})),$(".fg-float")[0]&&$(".fg-float .form-control").each(function(){var e=$(this).val();0==!e.length&&$(this).closest(".fg-line").addClass("fg-toggled")}),$("[data-hide]").on("click",function(){$(this).closest("."+$(this).attr("data-hide")).addClass("hide")}),jQuery.fn.serializeObject=function(){var e={},t=this.serializeArray();return $.each(t,function(){void 0!==e[this.name]?(e[this.name].push||(e[this.name]=[e[this.name]]),e[this.name].push(this.value||"")):e[this.name]=this.value||""}),e},$("body").on("focus",".hs-input",function(){$(".h-search").addClass("focused")}),$("body").click(function(e){$(e.target).hasClass("hs-input")||($(".hs-input").val(""),$(".h-search").removeClass("focused"))}),$("body").on("click",".hc-trigger",function(){$(this).parent().toggleClass("toggled")}),$("body").on("click",".hc-item",function(){var e=$(this).data("ma-header-value");$(".hc-item").removeClass("selected"),$(this).addClass("selected"),$("body").attr("data-ma-header",e)}),$('[data-action="fullscreen"]')[0]){var t=$("[data-action='fullscreen']");t.on("click",function(e){function a(e){e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()}e.preventDefault(),a(document.documentElement),t.closest(".dropdown").removeClass("open")})}}function t(e,t){$.notify({message:e},{type:t,allow_dismiss:!1,label:"Cancel",className:"btn-xs btn-inverse",delay:800,animate:{enter:"animated fadeInRight",exit:"animated fadeOutRight"},offset:{x:30,y:30}})}function a(){$("form .cancel").on("click",function(e){$(e.target).closest("form").trigger("reset")})}function r(){$('[data-toggle="tooltip"]')[0]&&$('[data-toggle="tooltip"]').tooltip()}function s(){$('[data-toggle="popover"]')[0]&&$('[data-toggle="popover"]').popover()}function o(){$("body").on("click","[data-ma-action]",function(e){e.preventDefault();var t=$(this).data("ma-action"),a=$(this);switch(t){case"sidebar-open":var r=$(this).data("ma-target");if("main-menu"==r){if($("body").width()>=1024){var s=$("#main").hasClass("open");s?$("#main").removeClass("open"):$("#main").addClass("open");break}$("#s-main-menu").addClass("toggled")}a.addClass("toggled"),$("#main").append('<div data-ma-action="sidebar-close" class="sidebar-backdrop animated fadeIn" />'),"user-alerts"==r&&$("#s-user-alerts").addClass("toggled"),$("body").addClass("o-hidden");break;case"sidebar-close":$('[data-ma-action="sidebar-open"]').removeClass("toggled"),$("#main").removeClass("toggled"),$(".sidebar").removeClass("toggled"),$(".sidebar-backdrop").remove(),$("body").removeClass("o-hidden");break;case"search-clear":$(".h-search").removeClass("toggled"),$(".hs-input").val(""),$(".h-search").removeClass("focused");break;case"search-open":$(".h-search").addClass("toggled"),$(".hs-input").focus();break;case"submenu-toggle":a.next().slideToggle(200),a.parent().toggleClass("toggled");break;case"message-toggle":$(".ms-menu").toggleClass("toggled"),a.toggleClass("toggled");break;case"ah-search-open":i=$(this).closest(".action-header").find(".ah-search"),i.fadeIn(300),i.find(".ahs-input").focus();break;case"ah-search-close":i.fadeOut(300),setTimeout(function(){i.find(".ahs-input").val("")},350);break;case"clear-notification":console.log("start clear-notification");var o=a.parent().closest(".tab-pane"),i=o.find(".list-group"),n=i.find(".list-group-item"),l=n.size();a.parent().fadeOut(),i.find(".list-group").prepend('<i class="grid-loading hide-it"></i>'),i.find(".grid-loading").fadeIn(1500);var u=0;n.each(function(){var e=$(this);setTimeout(function(){e.addClass("animated fadeOutRightBig").delay(1e3).queue(function(){e.remove()})},u+=150)}),setTimeout(function(){o.addClass("empty")},150*l+200)}})}function i(){e(),a(),o()}return{init:i,notify:t,toggleTooltip:r,togglePopover:s}}();$(document).ready(function(){App.init()}),$(document).ready(function(){!function(){Waves.attach(".btn:not(.btn-icon):not(.btn-float)"),Waves.attach(".btn-icon, .btn-float",["waves-circle","waves-float"]),Waves.init()}()});var Pwd=function(){function e(e){if(e.indexOf("@")>0)return e;if(11==e.length&&"1"==e.substr(0,1))return"%2B86 "+e;var t=/school_code=([^&^#]+)/.exec(window.location.href),a=null==t?null:t[1];if(null==a){var r=window.location.hostname.lastIndexOf(".edu");if(r>0){var s=window.location.hostname.substring(0,r);a=s.substring(s.lastIndexOf(".")+1,r)}}return null!=a?a+":"+e:e}function t(e){if(void 0==e||e.length<1)return"null";var t=e.length;if(1==t)return e[0].username;var a=/school_code=([^&^#]+)/.exec(window.location.href),r=null==a?null:a[1];if(null==r){var s=window.location.hostname.lastIndexOf(".edu");if(s>0){var o=window.location.hostname.substring(0,s);r=o.substring(o.lastIndexOf(".")+1,s)}}if(null==r)return e[t-1].username;for(var i=0;i<t;i++)if(e[i].host==r)return e[i].username}function a(){var e=document.location.hash;r(e,"img"),$(window).on("hashchange",function(){r(e,"img")})}function r(e,t){void 0!=e&&""!=e&&($(".l-block").removeClass("toggled"),setTimeout(function(){$(".login").attr("data-lbg",t),$(e).addClass("toggled")}))}function s(e,t,a){1!=a&&void 0!=f&&(e.removeAttr("disabled",!0),e.text("发送验证码"),clearTimeout(f)),e.attr("disabled",!0),e.text("重新发送("+t+")"),t>0?(t--,f=setTimeout(function(){s(e,t,!0)},1e3)):(e.removeAttr("disabled",!0),e.text("重新发送"),clearTimeout(f))}function o(e){if(void 0!=p.passwordStatus[e]&&p.passwordStatus[e].ok){switch(e){case"email":$("#l-forget-password-email .input-hint").text(p.passwordStatus.email.data),r("#l-forget-password-email","purple");break;case"phone":$("#l-forget-password-phone .input-hint").text(p.passwordStatus.phone.data),r("#l-forget-password-phone","purple");break;case"qa":$("#l-forget-password-qa .input-hint-1").text("1. "+p.passwordStatus.qa.data.qas[0].q),$("#l-forget-password-qa .input-hint-2").text("2. "+p.passwordStatus.qa.data.qas[1].q),r("#l-forget-password-qa","purple")}return!0}var t=["email","phone","qa"],a=t.indexOf(e);return a>=0?(a++,o(t[a]),!0):(r("#l-forget-password-none","grey"),!0)}function i(e){if(!e.isDefaultPrevented()){e.preventDefault();var t=$(e.target),a=$(".form-group",t);a.removeClass("has-error"),$(".with-errors",a).text("");var s=t.serializeArray();s.push({name:"uid",value:p.uid}),s.push({name:"to",value:p.to}),$.ajax({type:"POST",url:"apis/v1/validate",headers:{Accept:"application/json"},data:s,success:function(e){p.token=e.token,r("#l-forget-password-setup","blue"),$(".with-errors",a).text(""),a.removeClass("has-error"),$("[name='to']",t).removeAttr("disabled"),t.trigger("reset")},error:function(e,t,r){400==e.status?$(".with-errors",a).text("输入的验证码不正确，请重试"):406==e.status?$(".with-errors",a).text("你本次尝试的次数过多，请返回重试"):$(".with-errors",a).text("服务器异常，请稍后再试"),a.addClass("has-error")}})}}function n(e){var t=$(".send-validate",e),a=$(".form-group",e);a.removeClass("has-error"),$(".with-errors",a).text("");var r=e.serializeArray();console.log(r[0].value),r[0].value.indexOf("@")<0&&11==r[0].value.length&&(r[0].value="+86 "+r[0].value),r.push({name:"uid",value:p.uid}),t.attr("disabled","disabled"),$.ajax({type:"GET",url:"apis/v1/validate",headers:{Accept:"application/json"},data:r,success:function(o){s(t,60),p.to=r[0].value,$(".with-errors",a).text(""),a.removeClass("has-error"),$("[name='to']",e).attr("disabled","disabled"),$(".with-errors",a)[0].remove(),t.attr("style","float: right;  margin-bottom: 0; margin-bottom: -23px; z-index: 99"),t.next().removeClass("hide"),$('button[type="submit"]',e).removeClass("hide"),$(".title-hint",e).text("请查收验证码,并输入"),$("input[name='token']",e).focus()},error:function(e,r,s){400==e.status?$(".with-errors",a).text("您的输入不匹配，请重新输入"):$(".with-errors",a).text("服务器异常，请稍后再试"),a.addClass("has-error"),t.removeAttr("disabled")}})}function l(){function e(){p.v++,$("#captcha").attr("src","apis/captcha/captcha.png?r="+p.register.captchaId+"&v="+p.v)}function t(t){var a=$(".captcha-group",t),r=$(".to-group",t),o=t.serializeArray(),i="+86 "+o[2].value;return o=[{name:"captcha",value:o[3].value},{name:"captchaid",value:p.register.captchaId},{name:"to",value:i}],$(".token-group  input[type='text']",t).val(""),$(".with-errors",r).text(""),p.needCaptcha&&o[0].value.length<4?(a.removeClass("hide"),a.addClass("has-warning"),void $("input",a).focus()):($(".with-errors",a).text(""),$(".token-group button",t).attr("disabled","disabled"),void $.ajax({type:"GET",url:"apis/v1/register",headers:{Accept:"application/json"},data:o,success:function(e){if(void 0!=e.tokenid){p.register={tokenid:e.tokenid},a.addClass("hide"),$(".token-group input",t).focus();var o=$(".token-group button",t);s(o,60),$(".token-group .fg-label",t).text("验证码"),$(".token-group .help-block",t).text("我们已经向您发送了一条验证码，请查证后输入"),$(".token-group",t).addClass(" has-success"),$(".token-group  input[type='text']",t).removeAttr("disabled"),$("input",a).text("")}else void 0!=e.captcha?(a.removeClass("hide"),a.addClass("has-warning"),p.register.captchaId=e.captcha,$("img",a).attr("src","apis/captcha/captcha.png?r="+e.captcha+"&v="+p.v),p.v++,p.needCaptcha=!0,$(".token-group button",t).removeAttr("disabled")):($(".with-errors",r).text("服务器异常，请稍后重试"),$(".token-group button",t).removeAttr("disabled"))},error:function(s,o,i){if(400==s.status)$(".with-errors",r).text("您输入的手机号码不正确，请重新输入");else if(409==s.status)$(".with-errors",r).text("您输入的手机号码已被使用，请重新输入");else{if(406==s.status)return $(".with-errors",a).text("验证码不正确"),a.addClass("has-error"),$(".token-group button",t).removeAttr("disabled"),void e();503==s.status?($(".with-errors",r).text("验证码发送失败，请稍后再试"),e()):$(".with-errors",r).text("服务器异常，请稍后重试")}r.addClass("has-error"),$(".token-group button",t).removeAttr("disabled")}}))}p.v=0,p.register={},$("#captcha").click(e),$("#l-register form").validator(),$("#l-register input[name='to']").on("input",function(){$(this).val().length>=11?$("#l-register .token-group").removeClass("hide"):($("#l-register .token-group").addClass("hide"),$('#l-register .captcha-group  input[type="text"]').val(""),$("#l-register .captcha-group").addClass("hide"))}),$("#l-register .token-group :button").click(function(e){e.preventDefault();var a=$(this).parents("form"),r=a.serializeArray();if(11!=r[2].value.length){var s=$(".to-group",a);return $(".with-errors",s).text("请输入正确的手机号码"),void s.addClass("has-error")}$(".with-errors",s).text("");$(".captcha-group",a);return r[3].value.length<6?void t(a):void t(a)}),$("#l-register form").submit(function(e){if(!e.isDefaultPrevented()){e.preventDefault();var t=$(e.target),a=$(".alert",t),r=$(".form-group",t);r.removeClass("has-error"),a.addClass("hide"),$(".with-errors",r).text("");var s=t.serializeArray();s[2].value="+86 "+s[2].value,s.push({name:"tokenid",value:p.register.tokenid}),p.login={username:s[2].value,password:s[1].value},$.ajax({type:"POST",url:"apis/v1/register",headers:{Accept:"application/json"},data:s,success:function(e){$(".with-errors",r).text(""),r.removeClass("has-error"),d(p.login.username,p.login.password)},error:function(e,t,r){400==e.status?a.text("您输入的验证码不正确，请重试"):409==e.status?a.text("您输入的手机号码已被注册，请重新输入"):a.text("服务器异常，请稍后重试"),a.removeClass("hide")}})}})}function u(){function a(){return void 0!=p.previous&&(r("#"+p.previous.id,p.previous.bg),!0)}$("#l-forget-password-email .send-validate").click(function(e){e.preventDefault();var t=$(this).parents("form"),a=t.serializeArray(),r=a[0].value;r.indexOf("@")<0||n(t)}),$("#l-forget-password-phone .send-validate").click(function(e){e.preventDefault();var t=$(this).parents("form"),a=t.serializeArray(),r=a[0].value;11==r.length&&n(t)}),$("#l-forget-password-email form").validator().submit(function(e){i(e)}),$("#l-forget-password-phone form").validator().submit(function(e){i(e)}),$("#l-forget-password form").validator().submit(function(t){if(!t.isDefaultPrevented()){t.preventDefault();var a=$(t.target),s=$(".form-group",a);s.removeClass("has-error"),$(".with-errors",s).text("");var i=a.serializeArray();i[0].value=e(i[0].value),p.login={username:i[0].value},$.ajax({type:"POST",url:"apis/v1/status",headers:{Accept:"application/json"},data:i,success:function(e){p.uid=e.uid,e.firstlgin?r("#l-forget-password-setup-0","blue"):(p.passwordStatus=e.status,console.log(e),o("email")),$(".with-errors",s).text(""),s.removeClass("has-error"),a.trigger("reset")},error:function(e,t,a){404==e.status?$(".with-errors",s).text("您输入的账号不存在，请重试"):$(".with-errors",s).text("服务器异常，请稍后再试"),s.addClass("has-error")}})}}),$("#l-forget-password-qa form").validator().submit(function(e){if(!e.isDefaultPrevented()){e.preventDefault();var t=$(e.target),a=$(".alert",t),s=$(".form-group",t);s.removeClass("has-error"),$(".with-errors",s).text(""),a.addClass("hide");var o=t.serializeArray(),i=[{q:p.passwordStatus.qa.data.qas[0].q,a:o[0].value},{q:p.passwordStatus.qa.data.qas[1].q,a:o[1].value}];o=[],o.push({name:"data",value:JSON.stringify(i)}),o.push({name:"uid",value:p.uid}),o.push({name:"to",value:"qa"}),$.ajax({type:"POST",url:"apis/v1/validate",headers:{Accept:"application/json"},data:o,success:function(e){p.token=e.token,r("#l-forget-password-setup","blue"),$(".with-errors",s).text(""),s.removeClass("has-error"),t.trigger("reset")},error:function(e,t,r){a.removeClass("hide"),400==e.status?a.text("您输入的答案不匹配，请重新输入"):406==e.status?a.text("你本次尝试的次数过多，请1小时候后重试"):a.text("服务器异常，请稍后再试"),s.addClass("has-error")}})}}),$("#l-forget-password-setup-0, #l-first-use").find("form").validator().submit(function(a){if(!a.isDefaultPrevented()){a.preventDefault();var s=$(a.target),o=$(".alert",s),i=$(".form-group",s);i.removeClass("has-error"),o.addClass("hide"),$(".with-errors",i).text("");var n=s.serializeArray();"loginname"==n[0].name&&(n[0].value=e(n[0].value)),n[2].value=p.uid,$.ajax({type:"GET",url:"apis/v1/init",headers:{Accept:"application/json"},data:n,success:function(e){p.token=e.token,"loginname"!=n[0].name&&(p.uid=e.uid,p.login={username:"[uid]"+p.uid},$("#l-forget-password-setup-1").find(".localid").text("您的学工号是 "+t(e.linkedaccounts)+"，")),r("#l-forget-password-setup-1","blue"),$(".with-errors",i).text(""),i.removeClass("has-error"),s.trigger("reset")},error:function(e,t,a){400==e.status?o.text("您输入的信息不匹配，请重新输入"):404==e.status?o.text("未找到该证件号的用户，请重新输入"):403==e.status?o.text("您不是第一次登录，请返回登录界面，使用您的学工号和密码进行登录"):o.text("服务器异常，请稍后重试"),o.removeClass("hide")}})}}),$("#l-forget-password-setup-1 form").validator().submit(function(e){if(!e.isDefaultPrevented()){e.preventDefault();var t=$(e.target),a=$('button[type="submit"]',t),o=$(".form-group",t);o.removeClass("has-error"),$(".with-errors",o).text("");var i=t.serializeArray();i[1].value=p.uid,i[2].value=p.token,a.attr("disabled","disabled"),$.ajax({type:"POST",url:"apis/v1/init",headers:{Accept:"application/json"},data:i,success:function(e){p.email=i[0].value,s(a,60),p.previous={id:"l-forget-password-setup-1",bg:"purple"},$("#back").addClass("hide"),setTimeout(function(){$("#back").removeClass("hide")},3e4),r("#l-forget-password-setup-2","purple"),$(".with-errors",o).text(""),o.removeClass("has-error"),t.trigger("reset")},error:function(e){400==e.status?$(".with-errors",o).text("请输入正确的邮箱"):409==e.status?$(".with-errors",o).text("输入的邮箱已被其他人使用，请重新输入或通过该邮箱找回密码"):$(".with-errors",o).text("服务器异常，无法发送邮件，请稍后再试，或者联系网络管理员开通邮件发送权限。"),o.addClass("has-error"),a.removeAttr("disabled")}})}}),$("#l-forget-password-setup-2 form").validator().submit(function(e){if(!e.isDefaultPrevented()){e.preventDefault();var t=$(e.target),a=$('button[type="submit"]',t),o=$(".form-group",t);o.removeClass("has-error"),a.attr("disabled","disabled"),$(".with-errors",o).text("");var i=t.serializeArray();i[1].value=p.uid,i[2].value=p.email,$.ajax({type:"POST",url:"apis/v1/init",headers:{Accept:"application/json"},data:i,success:function(e){s(a,60),p.token=e.token,p.passwdType="init",r("#l-forget-password-setup","blue"),$(".with-errors",o).text(""),o.removeClass("has-error"),t.trigger("reset")},error:function(e){400==e.status?$(".with-errors",o).text("您输入的验证码不正确，请重试"):409==e.status?$(".with-errors",o).text("输入的邮箱已被其他人使用，请刷新页面重试"):$(".with-errors",o).text("服务器异常，请稍后再试"),o.addClass("has-error"),a.removeAttr("disabled")}})}}),$("#l-forget-password-setup form").validator().submit(function(e){if(!e.isDefaultPrevented()){e.preventDefault();var t=$(e.target),a=$(".alert",t),r=$(".form-group",t);r.removeClass("has-error"),a.addClass("hide"),$(".with-errors",r).text("");var s=t.serializeArray(),o="apis/v1/passwordreset";s.push({name:"uid",value:p.uid}),s.push({name:"token",value:p.token}),p.login.password=s[0].value,$.ajax({type:"POST",url:o,headers:{Accept:"application/json"},data:s,success:function(e){$(".with-errors",r).text(""),r.removeClass("has-error"),t.trigger("reset"),a.removeClass("alert-danger"),a.addClass(" alert-success"),a.text("重置密码成功，正在跳转到登录..."),a.removeClass("hide"),d(p.login.username,p.login.password)},error:function(e,t,r){400==e.status?a.text("输入的密码格式不正确，请重试"):a.text("服务器异常，请稍后重试"),a.removeClass("hide")}})}}),$("#back").click(a)}function d(e,t,a){var r=/redirect_uri=([^&^#]+)/.exec(window.location.href),s=null!=r&&r.length>1?r[1]:"/",o=[{name:"username",value:e},{name:"password",value:t},{name:"remember_me",value:a},{name:"redirect_uri",value:decodeURIComponent(s)}];$.ajax({type:"POST",url:"/auth/login",headers:{Accept:"application/json"},data:o,success:function(e){window.location.replace(e.redirect_uri)},error:function(e,t,a){setTimeout(function(){window.location.href="/account/login"+window.location.search},1e3)}})}function c(){u(),l(),a()}var p={};$(".login")[0]&&$("body").on("click",".l-block [data-block]",function(e){e.preventDefault();var t=$(this).data("block"),a=$(this).data("bg");r(t,a)});var f;return{init:c,tryResetPasswordWith:o}}();$(document).ready(function(){Pwd.init()});